---
- include: ../elliptics-start.yml

- hosts: clients
  tasks:
    - name: Install proxy packages
      apt: name={{ item }}
      with_items:
        - fastcgi-daemon2
        - libfastcgi2-syslog
        - nginx

    - name: Install elliptics-fastcgi
      shell: sudo apt-get install elliptics-fastcgi=*~ell25

    - name: Create tmp directory
      file: path={{ item }} state=directory
      with_items:
        - "{{ fastcgi_log_dir }}"
        - "{{ fastcgi_tmp_dir }}"

    - name: Prepare nginx config
      template: src=templates/nginx.conf.j2 dest=/etc/nginx/nginx.conf

    - name: Prepare fastcgi-daemon config
      template: src=templates/fastcgi_config.xml.j2 dest={{ fastcgi_config_path }}

    - name: Start nginx
      shell: service nginx restart

    - name: Get fastcgi-daemon status
      shell: >
        start-stop-daemon
        --name={{ fastcgi_daemon_name }}
        --status
      ignore_errors: yes
      register: fastcgi_daemon_running

    - name: Stop fastcgi-daemon
      shell: >
        start-stop-daemon
        --name={{ fastcgi_daemon_name }}
        --stop
      when: fastcgi_daemon_running|success

    - name: Start fastcgi-daemon
      shell: >
        start-stop-daemon
        --name={{ fastcgi_daemon_name }}
        --background
        --exec=/usr/sbin/fastcgi-daemon2
        --start -- --config={{ fastcgi_config_path }}

    - name: Ensure fastcgi-daemon is running
      shell: >
        start-stop-daemon
        --name={{ fastcgi_daemon_name }}
        --status
