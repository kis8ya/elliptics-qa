---
- hosts:
    - servers
    - clients
  sudo: yes
  tasks:
    - name: Install elliptics (old version)
      apt: >
        name=elliptics={{ elliptics_old_version }},elliptics-dbg={{ elliptics_old_version }},elliptics-client={{ elliptics_old_version }},eblob={{ eblob_old_version }},eblob-dbg={{ eblob_old_version }}
        force=yes
      when: inventory_hostname_short.rsplit("-", 1)[-1]|int is odd()

- hosts: servers
  sudo: yes
  roles:
    - ../roles/create-elliptics-directories

- hosts: servers
  vars:
    old_elliptics_config: templates/elliptics-v2.25.json.j2
  sudo: yes
  tasks:
    - name: Create Elliptics config file
      template: >
        src=../{{ old_elliptics_config
                  if inventory_hostname_short.rsplit("-", 1)[-1]|int is odd()
                  else elliptics_config }}
        dest={{ config_file_path }}

- hosts: servers
  sudo: yes
  tasks:
    - name: Start Elliptics daemon
      command: dnet_ioserv -c {{ config_file_path }}

    - name: Wait for Elliptics to start up
      pause: seconds=10

    - name: Ensure Elliptics is running
      shell: ps ax | grep [d]net_ioserv

- hosts: clients
  sudo: yes
  tasks:
    - name: Create client logging directory
      file:
        path={{ test_logs_path }}
        state=directory
        owner={{ ansible_ssh_user }}
