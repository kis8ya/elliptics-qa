---
- hosts: servers
  sudo: yes
  tasks:
    - name: Get process id
      shell: pidof dnet_ioserv
      register: pidof
      ignore_errors: yes

    - name: Stop Elliptics daemon
      shell: kill {{ pidof.stdout }}
      register: kill
      ignore_errors: yes
      when: pidof.rc == 0

    - name: Wait for Elliptics to stop
      shell: while [ -e /proc/{{ pidof.stdout }} ]; do sleep 0.1; done
      register: stop_nodes
      when: kill.get("rc", 3) == 0
      ignore_errors: yes
      async: 45
      poll: 1

- include: ../collect-artifacts.yml

- hosts: servers
  sudo: yes
  tasks:
    - name: Wipe out Elliptics directory
      file: path={{ elliptics_dir }} state=absent

- hosts: clients
  sudo: yes
  tasks:
    - name: Wipe out client and recovery logs
      file: path={{ item }} state=absent
      with_items:
        - "{{ client_log }}"
        - "{{ recovery_dc_dir }}"
        - "{{ recovery_merge_dir }}"

- hosts: servers
  tasks:
    - name: Handle errors
      fail: 'msg="Failed to stop Elliptics nodes: {{ stop_nodes.msg }}"'
      when: stop_nodes.rc != 0
